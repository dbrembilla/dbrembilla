<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style type="text/css">
        .pulsate-fwd {
            -webkit-animation: pulsate-fwd 0.5s ease-in-out infinite both;
                    animation: pulsate-fwd 0.5s ease-in-out infinite both;
        }
        @-webkit-keyframes pulsate-fwd {
          0% {
            -webkit-transform: scale(1);
                    transform: scale(1);
          }
          50% {
            -webkit-transform: scale(1.1);
                    transform: scale(1.1);
          }
          100% {
            -webkit-transform: scale(1);
                    transform: scale(1);
          }
        }
        @keyframes pulsate-fwd {
          0% {
            -webkit-transform: scale(1);
                    transform: scale(1);
          }
          50% {
            -webkit-transform: scale(1.1);
                    transform: scale(1.1);
          }
          100% {
            -webkit-transform: scale(1);
                    transform: scale(1);
          }
        }
    </style>

</head>

<body>
    <div class="container">
        <ul  id="article-choice">
            
        </ul>
        
    </div>
    <div style="border-color: darkred; width: 50%;" class="metadataviewer container">
        <h1>Metadata viewer</h1>
        <h2>Info</h2>
        <div>
            <ul id="info">
                
            </ul>
        </div>
        <h2>Places</h2>
        <div>
            <ul id="place-view">
                
            </ul>
        </div>
        <h2>Institution</h2>
        <div>
            <ul id="institution-view">
                
            </ul>
        </div>
        <h2>People</h2>
        <div>
            <ul id="person-view">
                
            </ul>
        </div>
    </div>
    <div class="container" id="file">
    
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script type="text/javascript">
        String.prototype.tpl = function(o) { //funzione che serve a inserire gli elementi nella lista dei documenti
            var r = this ; 
            for (var i in o) { 
                r = r.replace(new RegExp("\\$"+i, 'g'),o[i])  
            } 
            return r 
        }
        
        var listItemTpl = `<li><a href='#' onclick='load("$url")'>$label</a></li>` //elemento che serve ad aggiungere documenti. label Ã¨ la descrizione del doc e url la cipolla
        
        $(document).ready(main); //al caricamento del documento esegui main

        function main() { //recupera gli html
            $.ajax({
                method: 'GET',
                url: 'list.json',
                success: function(d) { //ciascun elemento nel json viene recuperato
                    for (var i=0; i<d.length; i++) {
                        $('#article-choice').append(listItemTpl.tpl({url:d[i].url, label: d[i].label}))
                    }   
                },
                error: function() {
                    alert('No document to show')
                }
            });
            
            
            
        }
        
        function load(file) { //carica il file html del documento desiderato. es. articolo.html viene caricato. 
            $.ajax({
                method: 'GET',
                url: file,
                success: function(d) {
                    $('#file').html(d) //aggiunge un div con id file (il documento)
                    $('#title').html($('#file h1')) //aggiunge un div con id title scegliendo l'elemento h1 nel div con id file
                    //$('.show').prop("checked", false)
                    addIds()
                    filltabs()
                },
                error: function() {
                    alert('Could not load file '+file)
                }
            });
        }


        function addIds() {
            addId('.person','person')
            addId('.place', 'place')
            addId('.institution', 'institution')
        }
        
        function addId(what, prefix) {
            var id = '0';
            var elements = $(what); //aggiunge un id progressivo in modo da identificare ciascun elemento della tabella
            for (var i=0; i<elements.length; i++) {
                elements[i].id = prefix + "-" + id++;
            }
        }

        function filltabs(){
            fillInfo("#file", "#info")
            filltab("#file .person","#person-view")
            filltab("#file .place","#place-view")
            filltab("#file .institution","#institution-view")
        }
        


        function filltab(what,where) { //questo riempie le tabelle del metadata viewer
            var listFirst = `<br><a id="$thisclass" href="$place">$content</a>`;
            var listSecond = ', <a id="$thisclass" href="#$place">$content</a>';
            var elements = $(what); 
            seenClasses = [];
            $(where).empty(); 
            for (var i=0; i<elements.length; i++) {
                var myClass = elements[i].getAttribute("class").toString();
                var referenceClass = myClass.replace("\s", "-");
                if (seenClasses.includes(referenceClass)) {
                    $("#" + referenceClass).id = "tmp" ;
                    $("tmp").after(listSecond.tpl({
                    place: '#'+elements[i].id,
                    content: elements[i].innerHTML,
                    thisclass: referenceClass
                }))
                    $("tmp").removeAttr("id");
                }
                else {
                    $(where).append(listFirst.tpl({
                    place: '#'+elements[i].id,
                    content: elements[i].innerHTML,
                    thisclass: referenceClass
                }) )
                    seenClasses.push(referenceClass)
                }
                
            }
        }
        
        function goto(id) {
            var t = $(id)[0].offsetTop; //sposta la vista all'elemento
            $('body').animate({ scrollTop: t }, 200);
            $(id).addClass('animate');
            setTimeout(function(){
                $(id).removeClass('animate');
            },5000);
        }

function fillInfo(from, where) {
            var item = `
                <p class="list title"><b>Title: </b> $title</p>
                <p class="list author"><b>Author: </b> $author</p>
                          
                ` ; //meta con le keyword
            $(where).empty(); 

            var title = $(from + ' h1')[0].innerText //sceglie elementi h1 nell'elemento indicato
            var author = $(from + ' .auth')[0].innerText //sceglie elemento con byline con autore
            
            $(where).append(item.tpl( {
                author: author,
                title: title,
            }))
        }
        $(function(){
       $("a").each(function(){
               if ($(this).attr("href") == window.location.pathname){
                       $(this).addClass("pulsate-fwd");
               }
       });
});
    </script>
</body>

</html>